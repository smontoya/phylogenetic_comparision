{% extends 'base.html' %}
{% block header_title%}
<h1>
  Comparar secuencias
</h1>
{%endblock%}
{%block body%}
<div class="box upload_form">
  <div class="box-header with-border">
      Subir archivos <small>Seleccione los archivos a comparar</small>
  </div>
  <div class="box-body">
    <div class="form-group">
      <label for="exampleInputEmail1">Titulo</label>
      <input type="text" class="form-control" id="titulo" placeholder="Ingrese un nombre para identificar el analisis">
    </div>

    <div class="form-group row">
      <div class="col-sm-11">
        <label>Secuencia 1</label>
        <textarea class="form-control" rows="3" id="newickTextArea1" placeholder="Escriba aqui su secuencia en formato newick"></textarea>
        <label>Ó</label>
        <button id="uploadBtn1" class="btn btn-large btn-primary">Seleccione su archivo</button>
        <div id="progressOuter1" class="progress progress-striped active" style="display:none;">
          <div id="progressBar1" class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="form-group row">
      <div class="col-sm-11">
        <label>Secuencia 2</label>
        <textarea class="form-control" rows="3" id="newickTextArea2" placeholder="Escriba aqui su secuencia en formato newick"></textarea>
        <label>Ó</label>
        <button id="uploadBtn2" class="btn btn-large btn-primary">Seleccione su archivo</button>
        <div id="progressOuter2" class="progress progress-striped active" style="display:none;">
          <div id="progressBar2" class="progress-bar progress-bar-success"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
        </div>
      </div>
    </div>
    <div class="row" style="padding-bottom:10px;">
      <div class=" alert col-xs-10">
        <div id="msgBox">
        </div>
      </div>
    </div>
    <button id="procesar" class="btn btn-primary btn-large">Procesar</button>
  </div>
</div>
<div class="box proccess_form">
  <div class="box-body">
    <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i> procesando
  </div>
</div>
<div class="box cargar_secuencias">
  <div class="box-header with-border">
      Cargar secuencia <small>Uno de los archivos no posee secuencia</small>
  </div>
  <div class="box-body">
    
  </div>
</div>
{%endblock%}

{%block extra_js%}
<script src="static/js/simpleAjaxUploader.min.js"></script>
<script type="text/javascript">


$(function() {
  $("#procesar").hide();
  $(".proccess_form").hide();
  $(".cargar_secuencias").hide();

  var file1 = false
  var file2 = false
  var comprobar_archivos = function(){
    if (file1 && file2){
      $("#procesar").show();
    }
  }

  var btn1 = document.getElementById('uploadBtn1'),
      progressBar1 = document.getElementById('progressBar1'),
      progressOuter1 = document.getElementById('progressOuter1');

  var btn2 = document.getElementById('uploadBtn2'),
      progressBar2 = document.getElementById('progressBar2'),
      progressOuter2 = document.getElementById('progressOuter2');

  var msgBox = document.getElementById('msgBox');

  var uploader = new ss.SimpleUpload({
        button: btn1,
        url: "{{url_for('upload_file', filename='tree1.tree')}}",
        name: 'uploadfile',
        data: {filename: 'tree1.tree'},
        multipart: true,
        hoverClass: 'hover',
        focusClass: 'focus',
        responseType: 'json',
        startXHR: function() {
            progressOuter1.style.display = 'block'; // make progress bar visible
            this.setProgressBar( progressBar1 );
        },
        onSubmit: function() {
            msgBox.innerHTML = ''; // empty the message box
            btn1.innerHTML = 'Subiendo...'; // change button text to "Uploading..."
          },
        onComplete: function( filename, response ) {
            btn1.innerHTML = "archivo: " + filename;
            progressOuter1.style.display = 'none'; // hide progress bar when upload is completed
            if ( !response ) {
                btn1.innerHTML = "Selecciona un archivo valido";
                msgBox.innerHTML = 'No se pudo subir el archivo';
                file1 = false;
                return;
            }
            if ( response.success == true ) {
              file1 = true;
              comprobar_archivos();
              $("#newickTextArea1").hide()

                msgBox.innerHTML = '<strong>' + filename + '</strong>' + ' ha subido correctamente.';
            } else {
                if ( response.msg )  {
                    msgBox.innerHTML = escapeTags( response.msg );
                } else {
                    msgBox.innerHTML = 'Ha ocurrido un error al intentaru subir su archivo';
                }
            }
          },
        onError: function() {
            progressOuter1.style.display = 'none';
            file1 = false;
            btn1.innerHTML = "Selecciona un archivo valido";
            msgBox.innerHTML = 'No se pudo subir el archivo 1';
          }
  });


  var uploader2 = new ss.SimpleUpload({
        button: btn2,
        url: "{{url_for('upload_file', filename='tree2.tree')}}",
        name: 'uploadfile',
        data: {filename: 'tree2.tree'},
        multipart: true,
        hoverClass: 'hover',
        focusClass: 'focus',
        responseType: 'json',
        startXHR: function() {
            progressOuter2.style.display = 'block'; // make progress bar visible
            this.setProgressBar( progressBar2 );
        },
        onSubmit: function() {
            msgBox.innerHTML = ''; // empty the message box
            btn2.innerHTML = 'Subiendo...'; // change button text to "Uploading..."
          },
        onComplete: function( filename, response ) {
            btn2.innerHTML = "archivo: " + filename;
            progressOuter2.style.display = 'none'; // hide progress bar when upload is completed
            if ( !response ) {
                btn2.innerHTML = "Selecciona un archivo valido";
                msgBox.innerHTML = 'No se pudo subir el archivo';
                file2 = false
                return;
            }
            if ( response.success == true ) {
                $("#newickTextArea2").hide()
                file2 = true
                comprobar_archivos();
                msgBox.innerHTML = '<stsrong>' + filename  + '</strong>' + ' ha subido correctamente.';
            } else {
                if ( response.msg )  {
                    msgBox.innerHTML = escapeTags( response.msg );
                } else {
                    msgBox.innerHTML = 'Ha ocurrido un error al intentaru subir su archivo';
                }
            }
          },
        onError: function() {
            progressOuter2.style.display = 'none';
            btn2.innerHTML = "Selecciona un archivo valido";
            msgBox.innerHTML = 'No se pudo subir el archivo 2';
            file2 = false
          }
  });
  $("#procesar").on("click", function(){
    $(".upload_form").hide();
    $(".proccess_form").show();
    $.ajax({
      method: "POST",
      url: "{{url_for('validador')}}",
    })
    .done(function( msg ) {
      var data = JSON.parse(msg)

      if ('ok' in data){
        $('.proccess_form').html('<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i> Analizando ...')
        $.ajax({
          method: "POST",
          url: "{{url_for('.analizar')}}",
        })
        .done(function( msg ) {
          var data = JSON.parse(msg);
          if ('ok' in data){
            window.location.replace(data['ok']);
          }else{
            $('.proccess_form').html('<i class="fa fa-exclamation-circle fa-3x fa-fw"></i>  '+ data["error"])
          }
        });
      }else{
        if (data['id'] == 4){
          $('.proccess_form').html('<i class="fa fa-exclamation-circle fa-3x fa-fw"></i>  '+ data["error"])
        }
        else if (data['id'] == 5){
          $('.proccess_form').html('<i class="fa fa-exclamation-circle fa-3x fa-fw"></i>  '+ data["error"])
        }
        else{
         $('.proccess_form').html('<i class="fa fa-exclamation-circle fa-3x fa-fw"></i>  '+ data["error"]) 
        }
      }
    });
  });

});
</script>
{% endblock %}